package com.gd.sql.injection.task;

import java.sql.*;

public class Main {
    // For the sake of simplicity:
    final static String url = "jdbc:postgresql://localhost:5432/users";
    final static String username = "user";
    final static String password = "password";


    public static void main(String[] args) {
        try {

            Connection connection = DriverManager.getConnection(url, username, password);

            System.out.println("\n ## S T A T E M E N T ##");
            System.out.println("Expected successful login");
            statement(connection, "user1","password1");

            System.out.println("\nExpected unsuccessful login");
            statement(connection,"test","any");


            System.out.println("\nSQL Injection");
            statement(connection,"whatever' OR 1=1 LIMIT 1 --","Doesn't really Matter what's in here");

            System.out.println("\n ## P R E P A R E D    S T A T E M E N T ##");
            System.out.println("Expected successful login");
            preparedStatement(connection, "user1","password1");

            System.out.println("\nExpected unsuccessful login");
            preparedStatement(connection,"test","any");


            System.out.println("\nSQL Injection");
            preparedStatement(connection, "whatever' OR 1=1 LIMIT 1 --","Doesn't really Matter what's in here");
        } catch (SQLException e) {
            System.out.println("Error : " + e.getMessage());
        }

    }


    private static void preparedStatement(Connection connection, String usernameInput, String passwordInput) throws SQLException {
        String loginQuery = "SELECT username FROM users WHERE username = ? AND password = ?";

        PreparedStatement preparedStatement = connection.prepareStatement(loginQuery);
        preparedStatement.setString(1, usernameInput);
        preparedStatement.setString(2, passwordInput);

        ResultSet resultSet = preparedStatement.executeQuery();
        System.out.println("Result: " + resultSet.getStatement().toString());


        if (resultSet.next()) {
            System.out.println("Successfully logged in : " + resultSet.getString("username"));
        } else {
            System.out.println("Username or password incorrect");
        }

        preparedStatement.close();
        resultSet.close();
    }

    public static void statement(Connection connection, String username, String password) throws SQLException {
        Statement statement = connection.createStatement();
        statement.execute("SELECT * FROM users WHERE username='" + username + "'" + " AND password = '" + password + "'");
        System.out.println("SELECT * FROM users WHERE username='" + username + "'" + " AND password = '" +  password + "'");

        //get result
        ResultSet result = statement.getResultSet();
        if (result.next()) {
            System.out.println("Successfully login as " + result.getString("username"));
        } else {
            System.out.println("Wrong username or password");
        }

        result.close();

        statement.close();
    }

}
